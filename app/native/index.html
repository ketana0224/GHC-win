<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GHC-win Native Chat</title>
    <style>
      body { margin: 0; font-family: "Segoe UI", sans-serif; background: #f3f5fb; }
      .wrap { max-width: 960px; margin: 18px auto; padding: 0 14px; }
      .panel { background: #fff; border: 1px solid #d8dced; border-radius: 10px; padding: 12px; }
      h1 { margin: 0 0 10px; font-size: 18px; }
      #log { height: 520px; overflow-y: auto; border: 1px solid #e0e4f1; border-radius: 8px; padding: 10px; background: #fcfdff; }
      .msg { margin: 0 0 10px; white-space: pre-wrap; word-break: break-word; }
      .msg b { color: #2b3d90; }
      .controls { display: flex; gap: 8px; margin-top: 10px; }
      textarea { width: 100%; min-height: 84px; resize: vertical; border: 1px solid #cfd5e7; border-radius: 8px; padding: 10px; font: inherit; }
      button { border: 1px solid #b8bfd8; background: #fff; border-radius: 8px; padding: 10px 14px; cursor: pointer; }
      button.primary { background: #2b3d90; color: #fff; border-color: #2b3d90; }
      button:disabled { opacity: 0.6; cursor: default; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="panel">
        <h1>GHC-win Native Chat</h1>
        <div id="log"></div>
        <div class="controls">
          <textarea id="prompt" placeholder="メッセージを入力"></textarea>
        </div>
        <div class="controls">
          <button id="send" class="primary">送信</button>
          <button id="clear">クリア</button>
        </div>
      </div>
    </div>

    <script>
      const log = document.getElementById("log");
      const prompt = document.getElementById("prompt");
      const send = document.getElementById("send");
      const clear = document.getElementById("clear");

      function escapeHtml(text) {
        return text
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll("\n", "<br>");
      }

      function append(role, text) {
        const p = document.createElement("p");
        p.className = "msg";
        p.innerHTML = `<b>${role}:</b> ${escapeHtml(String(text))}`;
        log.appendChild(p);
        log.scrollTop = log.scrollHeight;
      }

      async function submit() {
        const value = prompt.value.trim();
        if (!value) return;

        append("You", value);
        prompt.value = "";
        send.disabled = true;

        try {
          const result = await window.nativeApi.sendMessage(value);
          append("Copilot", result.answer);
        } catch (error) {
          append("System", `エラー: ${error?.message ?? String(error)}`);
        } finally {
          send.disabled = false;
          prompt.focus();
        }
      }

      send.addEventListener("click", submit);
      clear.addEventListener("click", () => {
        log.innerHTML = "";
      });
      prompt.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && (event.ctrlKey || event.metaKey)) {
          submit();
        }
      });

      append("System", "ネイティブGUIチャットを開始しました。Ctrl+Enter でも送信できます。");
      prompt.focus();
    </script>
  </body>
</html>
